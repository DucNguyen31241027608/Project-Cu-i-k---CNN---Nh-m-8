# =========================================================
# üç± H·ªÜ TH·ªêNG T√çNH TI·ªÄN KHAY C∆†M T·ª∞ ƒê·ªòNG (CNN + QR + Excel)
# =========================================================

!pip install gradio tensorflow opencv-python-headless pillow numpy pandas qrcode openpyxl --quiet

import gradio as gr
import cv2, qrcode, io, datetime, os
import numpy as np
import pandas as pd
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import img_to_array
from PIL import Image

# =====================================================
# 1Ô∏è‚É£ C·∫•u h√¨nh resize ·∫£nh & to·∫° ƒë·ªô c·∫Øt khay
# =====================================================
RESIZE_WIDTH, RESIZE_HEIGHT = 1024, 768

fixed_boxes = {
    "Khay 1": (80, 100, 460, 400),
    "Khay 2": (580, 100, 950, 420),
    "Khay 3": (80, 450, 300, 700),
    "Khay 4": (420, 450, 600, 700),
    "Khay 5": (720, 450, 950, 700)
}

# =====================================================
# 2Ô∏è‚É£ Danh s√°ch m√≥n ƒÉn (gi√° + calo)
# =====================================================
food_info = {
    "C∆°m tr·∫Øng": {"price": 10000, "calo": 200},
    "ƒê·∫≠u h≈© s·ªët c√†": {"price": 25000, "calo": 180},
    "C√° h√∫ kho": {"price": 30000, "calo": 250},
    "Th·ªãt kho tr·ª©ng": {"price": 30000, "calo": 350},
    "Th·ªãt kho": {"price": 25000, "calo": 280},
    "Canh chua c√°": {"price": 25000, "calo": 120},
    "Canh rau": {"price": 7000, "calo": 30},
    "Rau x√†o": {"price": 10000, "calo": 60},
    "S∆∞·ªùn n∆∞·ªõng": {"price": 30000, "calo": 320},
    "Tr·ª©ng chi√™n": {"price": 25000, "calo": 220},
}

# =====================================================
# 3Ô∏è‚É£ H√†m x·ª≠ l√Ω ·∫£nh
# =====================================================
def resize_image(img):
    return cv2.resize(img, (RESIZE_WIDTH, RESIZE_HEIGHT))

def preprocess_for_model(img, target_size=(128, 128)):
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    img = cv2.resize(img, target_size)
    img = img_to_array(img) / 255.0
    img = np.expand_dims(img, axis=0)
    return img

# =====================================================
# 4Ô∏è‚É£ T·∫°o m√£ QR thanh to√°n Momo
# =====================================================
def create_momo_qr(amount):
    momo_number = "0868842297"
    url = f"https://nhantien.momo.vn/{momo_number}/{amount}"
    qr_img = qrcode.make(url)
    buf = io.BytesIO()
    qr_img.save(buf, format='PNG')
    buf.seek(0)
    return Image.open(buf)

# =====================================================
# 5Ô∏è‚É£ H√†m ch√≠nh: nh·∫≠n di·ªán + t√≠nh ti·ªÅn + calo
# =====================================================
def analyze_food_tray(image, model_file, name):
    if image is None:
        return "‚ùå Ch∆∞a ch·ªçn ·∫£nh khay c∆°m", None, None, None
    if model_file is None:
        return "‚ùå Ch∆∞a t·∫£i m√¥ h√¨nh .h5", None, None, None

    try:
        model = load_model(model_file.name)
except Exception as e:
        return f"‚ùå L·ªói khi load m√¥ h√¨nh: {e}", None, None, None

    # N·∫øu model kh√¥ng c√≥ class_names, t·ª± g√°n
    class_names = list(food_info.keys())

    img = np.array(image)
    img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
    img = resize_image(img)

    total_price = 0
    total_calo = 0
    results = []
    crop_gallery = []

    for name_box, (x1, y1, x2, y2) in fixed_boxes.items():
        crop = img[y1:y2, x1:x2]
        crop_input = preprocess_for_model(crop)
        preds = model.predict(crop_input, verbose=0)

        idx = np.argmax(preds)
        conf = preds[0][idx]

        dish_name = class_names[idx] if idx < len(class_names) else f"L·ªõp {idx}"
        info = food_info.get(dish_name, {"price": 0, "calo": 0})

        total_price += info["price"]
        total_calo += info["calo"]

        results.append(f"üç± {name_box}: {dish_name} ({conf:.2f}) ‚Äî {info['price']:,}ƒë, {info['calo']} kcal")
        crop_gallery.append(Image.fromarray(cv2.cvtColor(crop, cv2.COLOR_BGR2RGB)))

    summary = f"""
üìÖ {datetime.datetime.now().strftime("%d/%m/%Y %H:%M:%S")}
üë§ Kh√°ch h√†ng: {name}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí∞ T·ªïng ti·ªÅn: {total_price:,} ƒë
üî• T·ªïng calo: {total_calo} kcal
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
""" + "\n".join(results)

    # L∆∞u Excel
    record = {
        "Th·ªùi gian": datetime.datetime.now().strftime("%d/%m/%Y %H:%M:%S"),
        "T√™n": name,
        "T·ªïng ti·ªÅn": total_price,
        "Calo": total_calo
    }

    file_path = "lich_su_khay_com.xlsx"
    if not os.path.exists(file_path):
        pd.DataFrame([record]).to_excel(file_path, index=False)
    else:
        old = pd.read_excel(file_path)
        pd.concat([old, pd.DataFrame([record])], ignore_index=True).to_excel(file_path, index=False)

    momo_qr = create_momo_qr(total_price)
    return summary, crop_gallery, f"T·ªïng ti·ªÅn: {total_price:,}ƒë | {total_calo} kcal", momo_qr

# =====================================================
# 6Ô∏è‚É£ Giao di·ªán Gradio
# =====================================================
with gr.Blocks(
    theme=gr.themes.Soft(primary_hue="orange", secondary_hue="pink"),
    css="""
    #app {background: linear-gradient(135deg,#FFF8E1,#FFE0B2);}
    h1 {text-align:center; color:#E65100;}
    p {text-align:center; color:#444;}
    """
) as app:
    gr.Markdown("<h1>üç± H·ªÜ TH·ªêNG KHAY C∆†M TH√îNG MINH</h1>")
    gr.Markdown("<p>T·ª± ƒë·ªông nh·∫≠n di·ªán m√≥n ƒÉn - t√≠nh ti·ªÅn - thanh to√°n Momo</p>")

    name = gr.Textbox(label="üë§ T√™n kh√°ch h√†ng", placeholder="Nh·∫≠p t√™n...")
    with gr.Row():
        input_image = gr.Image(label="üì∏ ·∫¢nh khay c∆°m ho·∫∑c Webcam", type="pil", sources=["upload", "webcam"])
        model_file = gr.File(label="üìÇ Upload m√¥ h√¨nh (.h5)")

    btn = gr.Button("üöÄ PH√ÇN T√çCH & T√çNH TI·ªÄN", variant="primary")
with gr.Row():
        output_text = gr.Textbox(label="üìã K·∫øt qu·∫£ chi ti·∫øt", lines=10)
        gallery = gr.Gallery(label="üß© ·∫¢nh t·ª´ng khay", columns=5, height=200)
    
    total_box = gr.Textbox(label="üí∞ T·ªïng k·∫øt nhanh", interactive=False)
    qr_display = gr.Image(label="üíµ Qu√©t m√£ Momo ƒë·ªÉ thanh to√°n")

    btn.click(analyze_food_tray, inputs=[input_image, model_file, name], outputs=[output_text, gallery, total_box, qr_display])

app.launch(debug=True)
