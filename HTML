<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoodScan - Nh·∫≠n di·ªán m√≥n ƒÉn</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #dbeafe;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --background: #f3f4f6;
      --white: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--background);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      font-size: 2em;
    }

    .logo-text h1 {
      font-size: 1.5em;
      color: var(--white);
      margin-bottom: 2px;
    }

    .logo-text p {
      font-size: 0.9em;
      color: rgba(255,255,255,0.8);
    }

    /* Main Content */
    .main-content {
      padding: 30px 0;
    }

    .scan-area {
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Camera Container */
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 0 auto 20px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 4/3;
    }

    #cameraStream, #preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    #cameraCanvas {
      display: none;
    }

    .placeholder-image {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--background);
      color: var(--text-light);
      font-size: 1.2em;
      flex-direction: column;
      gap: 10px;
    }

    /* Controls */
    .camera-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: var(--text-light);
      color: var(--white);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--text-dark);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }

    /* Image Adjustment Controls */
    .adjustment-controls {
      display: none;
      background: var(--primary-light);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .adjustment-controls.active {
      display: block;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .control-group input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #cbd5e1;
      outline: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--primary);
      font-size: 1.2em;
      font-weight: 600;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* Results Area */
    .results-area {
      margin-top: 30px;
    }

    .segments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .segment-card {
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: 2px solid var(--border);
    }

    .segment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .segment-card.detected {
      border-color: var(--success);
    }

    .segment-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: var(--background);
    }

    .segment-info {
      padding: 12px;
    }

    .segment-position {
      display: inline-block;
      background: var(--primary);
      color: var(--white);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .segment-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 6px;
      font-size: 0.95em;
    }

    .segment-confidence {
      color: var(--text-light);
      font-size: 0.85em;
      margin-bottom: 6px;
    }

    .segment-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: var(--text-dark);
    }

    .segment-price {
      color: var(--success);
      font-weight: 700;
    }

    .segment-calories {
      color: var(--warning);
    }

    /* Summary */
    .summary-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .summary-title {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .summary-row:last-child {
      border-bottom: none;
      font-size: 1.3em;
      font-weight: 700;
      padding-top: 15px;
    }

    .summary-label {
      font-weight: 500;
    }

    .summary-value {
      font-weight: 700;
      font-size: 1.1em;
    }

    /* Payment Button */
    .payment-section {
      margin-top: 20px;
      text-align: center;
    }

    .btn-payment {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 16px 48px;
      font-size: 1.2em;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      transition: all 0.3s;
    }

    .btn-payment:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .btn-payment:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* QR Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .modal-amount {
      font-size: 2em;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 20px;
    }

    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .qr-container img {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 8px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-close {
      flex: 1;
      padding: 12px 24px;
      background: var(--text-light);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-confirm {
      flex: 1;
      padding: 12px 24px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-close:hover {
      background: var(--text-dark);
    }

    .btn-confirm:hover {
      background: #059669;
    }

    .payment-note {
      color: var(--text-light);
      font-size: 0.9em;
      margin-top: 10px;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .camera-controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .segments-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="app-header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">üçΩÔ∏è</div>
          <div class="logo-text">
            <h1>FoodScan AI</h1>
            <p>Nh·∫≠n di·ªán m√≥n ƒÉn th√¥ng minh</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div class="scan-area">
        <h2 class="section-title">üì∏ Qu√©t khay ƒÉn</h2>
        
        <!-- Camera Container -->
        <div class="camera-container" id="cameraContainer">
          <video id="cameraStream" autoplay playsinline class="hidden"></video>
          <img id="preview" class="hidden" alt="Preview">
          <div class="placeholder-image" id="placeholder">
            <span style="font-size: 3em;">üì∑</span>
            <span>Ch·ª•p ·∫£nh ho·∫∑c t·∫£i l√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
          </div>
          <canvas id="cameraCanvas"></canvas>
        </div>
        
        <!-- Camera Controls -->
        <div class="camera-controls">
          <button class="btn btn-primary" onclick="startCamera()" id="cameraBtn">
            üé• B·∫≠t camera
          </button>
          <button class="btn btn-primary" onclick="capturePhoto()" id="captureBtn" disabled>
            üì∏ Ch·ª•p ·∫£nh
          </button>
          <input type="file" id="imageInput" accept="image/*" style="display: none;">
          <button class="btn btn-secondary" onclick="document.getElementById('imageInput').click()">
            üìÅ T·∫£i ·∫£nh l√™n
          </button>
          <button class="btn btn-success" onclick="analyzeImage()" id="analyzeBtn" disabled>
            ‚ú® Ph√¢n t√≠ch
          </button>
        </div>

        <!-- Image Adjustment Controls -->
        <div class="adjustment-controls" id="adjustmentControls">
          <h4 style="margin-bottom: 15px;">‚öôÔ∏è Ch·ªânh s·ª≠a ·∫£nh</h4>
          <div class="control-group">
            <label>üí° ƒê·ªô s√°ng: <span id="brightnessValue">0</span>%</label>
            <input type="range" id="brightnessSlider" min="-100" max="100" value="0">
          </div>
          <div class="control-group">
            <label>‚ö° ƒê·ªô t∆∞∆°ng ph·∫£n: <span id="contrastValue">0</span>%</label>
            <input type="range" id="contrastSlider" min="-100" max="100" value="0">
          </div>
          <div class="control-buttons">
            <button class="btn btn-success" onclick="applyAdjustments()">‚úÖ √Åp d·ª•ng</button>
            <button class="btn btn-secondary" onclick="resetAdjustments()">üîÑ ƒê·∫∑t l·∫°i</button>
          </div>
        </div>

        <!-- Loading Area -->
        <div id="loadingArea" class="loading hidden">üîÑ ƒêang ph√¢n t√≠ch</div>
        
        <!-- Results Area -->
        <div id="resultsArea" class="results-area hidden"></div>
      </div>
    </div>
  </div>

  <!-- QR Payment Modal -->
  <div class="modal-overlay" id="qrModal">
    <div class="modal-content">
      <div class="modal-header">üí≥ Qu√©t m√£ ƒë·ªÉ thanh to√°n</div>
      <div class="modal-amount" id="modalAmount">0ƒë</div>
      
      <div class="qr-container">
        <img id="qrCodeImage" src="qr-code.png" alt="QR Code Thanh to√°n">
      </div>
      
      <p class="payment-note">Vui l√≤ng qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
      
      <div class="modal-buttons">
        <button class="btn-close" onclick="closeQRModal()">‚ùå ƒê√≥ng</button>
        <button class="btn-confirm" onclick="confirmPayment()">‚úÖ ƒê√£ thanh to√°n</button>
      </div>
    </div>
  </div>

  <script>
    let stream = null;
    let currentImageData = null;
    let originalImageData = null;
    let brightness = 0;
    let contrast = 0;

    // Start Camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        const video = document.getElementById('cameraStream');
        const placeholder = document.getElementById('placeholder');
        const preview = document.getElementById('preview');
        
        video.srcObject = stream;
        video.classList.remove('hidden');
        placeholder.classList.add('hidden');
        preview.classList.add('hidden');
        
        document.getElementById('cameraBtn').textContent = 'üõë T·∫Øt camera';
        document.getElementById('cameraBtn').onclick = stopCamera;
        document.getElementById('captureBtn').disabled = false;
      } catch (error) {
        alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
      }
    }

    // Stop Camera
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        
        const video = document.getElementById('cameraStream');
        video.classList.add('hidden');
        
        if (!currentImageData) {
          document.getElementById('placeholder').classList.remove('hidden');
        }
        
        document.getElementById('cameraBtn').textContent = 'üé• B·∫≠t camera';
        document.getElementById('cameraBtn').onclick = startCamera;
        document.getElementById('captureBtn').disabled = true;
      }
    }

    // Capture Photo
    function capturePhoto() {
      const video = document.getElementById('cameraStream');
      const canvas = document.getElementById('cameraCanvas');
      const preview = document.getElementById('preview');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      currentImageData = canvas.toDataURL('image/jpeg');
      originalImageData = currentImageData;
      
      preview.src = currentImageData;
      preview.classList.remove('hidden');
      video.classList.add('hidden');
      document.getElementById('placeholder').classList.add('hidden');
      
      stopCamera();
      
      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('adjustmentControls').classList.add('active');
    }

    // Handle File Upload
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          currentImageData = event.target.result;
          originalImageData = currentImageData;
          
          const preview = document.getElementById('preview');
          preview.src = currentImageData;
          preview.classList.remove('hidden');
          
          document.getElementById('cameraStream').classList.add('hidden');
          document.getElementById('placeholder').classList.add('hidden');
          
          document.getElementById('analyzeBtn').disabled = false;
          document.getElementById('adjustmentControls').classList.add('active');
        };
        reader.readAsDataURL(file);
      }
    });

    // Image Adjustments
    document.getElementById('brightnessSlider').addEventListener('input', function(e) {
      brightness = parseInt(e.target.value);
      document.getElementById('brightnessValue').textContent = brightness;
    });

    document.getElementById('contrastSlider').addEventListener('input', function(e) {
      contrast = parseInt(e.target.value);
      document.getElementById('contrastValue').textContent = contrast;
    });

    function applyAdjustments() {
      if (!originalImageData) return;
      
      const canvas = document.getElementById('cameraCanvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        
        ctx.filter = `brightness(${100 + brightness}%) contrast(${100 + contrast}%)`;
        ctx.drawImage(img, 0, 0);
        
        currentImageData = canvas.toDataURL('image/jpeg');
        document.getElementById('preview').src = currentImageData;
      };
      
      img.src = originalImageData;
    }

    function resetAdjustments() {
      brightness = 0;
      contrast = 0;
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      document.getElementById('brightnessValue').textContent = 0;
      document.getElementById('contrastValue').textContent = 0;
      
      if (originalImageData) {
        currentImageData = originalImageData;
        document.getElementById('preview').src = currentImageData;
      }
    }

    // Analyze Image
    async function analyzeImage() {
      if (!currentImageData) {
        alert('Vui l√≤ng ch·ª•p ho·∫∑c t·∫£i ·∫£nh tr∆∞·ªõc!');
        return;
      }

      const loadingArea = document.getElementById('loadingArea');
      const resultsArea = document.getElementById('resultsArea');
      
      loadingArea.classList.remove('hidden');
      resultsArea.classList.add('hidden');

      try {
        const response = await fetch('http://localhost:5000/api/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            image: currentImageData
          })
        });

        const data = await response.json();

        if (data.success) {
          displayResults(data);
        } else {
          alert('L·ªói: ' + data.error);
        }
      } catch (error) {
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server: ' + error.message);
      } finally {
        loadingArea.classList.add('hidden');
      }
    }

    // Display Results
    function displayResults(data) {
      const resultsArea = document.getElementById('resultsArea');
      
      let html = '<h3 class="section-title">üç± K·∫øt qu·∫£ ph√¢n t√≠ch</h3>';
      
      // Segments
      html += '<div class="segments-grid">';
      data.segments.forEach(segment => {
        const detected = segment.prediction.detected;
        const detectedClass = detected ? 'detected' : '';
        
        html += `
          <div class="segment-card ${detectedClass}">
            <img src="data:image/jpeg;base64,${segment.image}" alt="Segment ${segment.position}">
            <div class="segment-info">
              <span class="segment-position">√î ${segment.position}</span>
              <div class="segment-name">${segment.prediction.name}</div>
              <div class="segment-confidence">ƒê·ªô tin c·∫≠y: ${segment.prediction.confidence}%</div>
              ${detected ? `
                <div class="segment-details">
                  <span class="segment-price">${segment.prediction.price.toLocaleString('vi-VN')}ƒë</span>
                  <span class="segment-calories">${segment.prediction.calories} cal</span>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      // Summary
      html += `
        <div class="summary-card">
          <div class="summary-title">üìä T·ªïng k·∫øt</div>
          <div class="summary-row">
            <span class="summary-label">S·ªë m√≥n ph√°t hi·ªán:</span>
            <span class="summary-value">${data.foods.length} m√≥n</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">T·ªïng calo:</span>
            <span class="summary-value">${data.total_calories.toLocaleString('vi-VN')} cal</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">T·ªïng ti·ªÅn:</span>
            <span class="summary-value">${data.total_price.toLocaleString('vi-VN')}ƒë</span>
          </div>
        </div>
      `;
      
      // Payment Section
      html += `
        <div class="payment-section">
          <button class="btn-payment" onclick="showQRPayment(${data.total_price})">
            üí∞ Thanh to√°n ${data.total_price.toLocaleString('vi-VN')}ƒë
          </button>
        </div>
      `;
      
      resultsArea.innerHTML = html;
      resultsArea.classList.remove('hidden');
    }

    // Show QR Payment Modal
    function showQRPayment(amount) {
      const modal = document.getElementById('qrModal');
      const modalAmount = document.getElementById('modalAmount');
      
      // Update amount
      modalAmount.textContent = amount.toLocaleString('vi-VN') + 'ƒë';
      
      // Show modal
      modal.classList.add('active');
    }

    // Close QR Modal
    function closeQRModal() {
      const modal = document.getElementById('qrModal');
      modal.classList.remove('active');
    }

    // Confirm Payment
    function confirmPayment() {
      alert('‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n!\n\nCh√∫c b·∫°n ƒÉn ngon mi·ªáng! üòä');
      closeQRModal();
    }

    // Close modal when clicking outside
    document.getElementById('qrModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQRModal();
      }
    });
  </script>
</body>
</html>
